<!doctype html>
<html lang="en">

<head>
	<!-- Required meta tags -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<!-- Bootstrap CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.2.2/gh-fork-ribbon.min.css" />
	<title>ncGraphQL Demonstration</title>
	<script src="ncgraphql.js"></script>
	<script>
		// https://stackoverflow.com/questions/14780350/convert-relative-path-to-absolute-using-javascript
		var absolutePath = function(href) {
			var link = document.createElement("a");
			link.href = href;
			return (link.protocol + "//" + link.host + link.pathname + link.search + link.hash);
		}
	</script>
	<style>
		.btn-circle {
			border: 1px solid rgba(0, 0, 0, 0.25);
			background-color: white;
			height: 34px;
			width: 34px;
			border-radius: 17px;
			margin: 0;
			padding: 0;
			box-shadow: 0 1px 0 #fff;
			cursor: pointer;
		}
		.btn-tight {
			border: 1px solid rgba(0, 0, 0, 0.25);
			height: 36px;
			width: 36px;
			margin: 0;
			padding: 0;
			box-shadow: 0 1px 0 #fff;
			cursor: pointer;
		}
	</style>
</head>

<body class="container">
	<h1>ncGraphQL</h1>
	<p>Free your data! Let developers run <a target="_blank" href="https://graphql.org/learn/">GraphQL</a> queries against <a target="_blank" href="https://www.loc.gov/preservation/digital/formats/fdd/fdd000330.shtml">NetCDF v3</a> files, in the browser. <a title="view the project on github" href="https://github.com/IrishMarineInstitute/ncgraphql.js">Find out more...</a>
	</p>
	<!-- Optional JavaScript -->
	<!-- jQuery first, then Popper.js, then Bootstrap JS -->
	<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
	<dl class="row">
		<dt class="col-sm-2">Evaluating</dt>
		<dl class="col-sm-9" id="filename"></dl>
	</dl>
	<script>
		var nc = undefined;
		var truncate_arrays = function(a, len) {
			if (a === null || a === undefined) {
				return a;
			}
			len = len || 1000;
			if (Array.isArray(a)) {
				if (a.length > len) {
					a = a.slice(0, len + 1);
					a[len + 1] = "data was truncated for display...";
				}
				return a;
			}
			if (typeof a === "object") {
				Object.keys(a).forEach(function(key) {
					a[key] = truncate_arrays(a[key], len);
				});
				return a;
			} else {
				return a;
			}
		}

		function basename(str) {
			var base = new String(str).substring(str.lastIndexOf('/') + 1);
			if (base.lastIndexOf(".") != -1)
				base = base.substring(0, base.lastIndexOf("."));
			return base;
		}
		var executeQuery = function(fn) {
			var query = $("#query").val().trim() || "{ncdump}";
			document.getElementById("result").innerText = "Running query...";
			nc.query(query).then(function(result) {
				document.getElementById("result").innerText = "Rendering result to page...";
				if (fn) {
					try {
						fn(result);
					} catch (e) {
						document.getElementById("result").innerText = "Something went wrong...\n\n" + e;
					}
				} else {
					document.getElementById("result").innerText = JSON.stringify(truncate_arrays(result, 200), null, 2);
				}
			}).catch(function(e) {
				document.getElementById("result").innerText = "Something went wrong...\n\n" + e;
			});
		}
		var showQuery = function(query){
			$("#query").val(query);
			document.getElementById("result").innerText = "Now press the Execute Query button!";
		}
		var examples = {
			globals: function() {
				$("#query").val("{ ncdump { globalAttributes { name } } }");
				executeQuery(function(result) {
					var names = result.ncdump.globalAttributes.map(function(x) {
						return x.name
					});
					names.sort(function(a, b) {
						return a.toLowerCase().localeCompare(b.toLowerCase());
					});
					var docs = [
						"# This query for the Global Attributes was generated by",
						"# mapping the results of an ncdump query like this:",
						"# { ncdump { globalAttributes { name } } }"].join("\n");
					showQuery(docs+"\n{\n  " + names.join("\n  ") + "\n}");
				});
			},
			custom_query: function() {
				$("#query").val("{\n graphql_example\n}");
				executeQuery(function(result) {
					showQuery("# This custom query was created using\n# the built-in {graphql_example} feature\n\n"+result.graphql_example);
				});
			},
			ncdump: function() {
					showQuery("# The {ncdump} built-in feature\n# can be used to inspect the NetCDF file\n{\n  ncdump\n}");
			},
			example: function(){
				showQuery("# The built-in {graphql_example} feature\n# generates a custom query for your NetCDF\n\n{graphql_example}");
			}

		}
		var fetchExampleNetCDF = function(){
			document.getElementById("result").innerText = "Fetching data..."
			var url = absolutePath($("#example_netcdf").val());
			nc = new ncGraphQL(url);
			setFileName(basename(url));
			$("#example_queries").val("none");
			examples.custom_query();
		}
		$(document).ready(function() {
			$("#example_queries").change(function(){
				if(examples[$("#example_queries").val()]){
					examples[$("#example_queries").val()]();
				}
			});
			$("#example_netcdf").change(fetchExampleNetCDF);
			$("#go").click(executeQuery)
			$("#ncfile").on('change', handleFileSelect);
			fetchExampleNetCDF();
		});

		var setFileName = function(name) {
			$("#filename").text(name);
		}

		var ncreader;

		function abortRead() {
			ncreader.abort();
		}

		function handleFileSelect(evt) {

			ncreader = new FileReader();
			ncreader.onerror = errorHandler;
			ncreader.onabort = function(e) {
				alert('File read cancelled');
			};
			ncreader.onloadstart = function(e) {
				document.getElementById("result").innerText = "Loading file...\n\n";
			};
			ncreader.onload = function(e) {
				try {
					nc = new ncGraphQL(this.result);
					setFileName(basename(evt.target.files[0].name));
					$("#example_queries").val("none");
					examples.custom_query();
				} catch (e) {
					$("#query").val("");
					document.getElementById("result").innerText = "Something went wrong...\n" + e;
				}
			}
			ncreader.readAsArrayBuffer(evt.target.files[0]);
		}


		function errorHandler(evt) {
			switch (evt.target.error.code) {
				case evt.target.error.NOT_FOUND_ERR:
					alert('File Not Found!');
					break;
				case evt.target.error.NOT_READABLE_ERR:
					alert('File is not readable');
					break;
				case evt.target.error.ABORT_ERR:
					break;
				default:
					alert('An error occurred reading this file.');
			};
		}
	</script>
	<div class="row">
		<div class="col-sm-5">
			<h3>GraphQL Query</h3>
			<textarea class="form-control" rows="20" id="query" placeholder="loading..."></textarea>
			<div class="input-group mb-3">
				<div class="input-group-prepend">
					<label class="input-group-text" for="example_queries">GraphQL Query</label>
				</div>
				<select class="custom-select" id="example_queries">
    			<option value="none" selected>Edit or Choose...</option>
    			<option value="globals">Global Attributes</option>
    			<option value="custom_query">Custom Query</option>
					<option value="ncdump">Built-in {ncdump}</option>
					<option value="example">Built-in {graphql_example}</option>
  		</select>
				<div class="input-group-append">
					<button id="go" class="btn btn-tight" title="Click to Execute Query"><svg width="34" height="34"><path d="M 11 9 L 24 16 L 11 23 z"></path></svg></button>
  			</div>
			</div>
			<div class="input-group mb-3">
				<div class="input-group-prepend">
					<label class="input-group-text" for="example_netcdf">NetCDF Input</label>
				</div>
				<select class="custom-select" id="example_netcdf">
    			<option selected value="test/data/X193.1.186.252.36.9.40.6-nc3.nc">X193.1.186.252.36.9.40.6-nc3.nc</option>
					<option value="test/data/ichthyop.nc">ichthyop.nc</option>
					<option value="test/data/madis-sao.nc">madis-sao.nc</option>
    			<option value="//erddap.marine.ie/erddap/tabledap/IWaveBNetwork.nc?longitude%2Clatitude%2Ctime%2Cstation_id%2CPeakPeriod%2CPeakDirection%2CUpcrossPeriod%2CSignificantWaveHeight%2CSeaTemperature&time%3E=now-1day">Irish Wave Buoys (ERDDAP)</option>
					<option value="//thredds.marine.ie/thredds/fileServer/IMI_TIDE/PREDICTIONS/GAUGE/MI_Tide_Predictions.nc">MI Tide Prediction (Thredds)</option>
					<option value="example">built-in {graphql_example}</option>
  		</select>
		</div>
			<label class="btn btn-success btn-file">
				Or try with your own NetCDF v3 file... <input id="ncfile" type="file" style="display: none;">
			</label>
		</div>
		<div class="col-sm-7">
			<h3>Result*</h3>
			<textarea class="form-control" rows="20" id="result" readonly placeholder="Press the GO button!"></textarea>
			<p>*long arrays in result may be truncated for display
		</div>
	</div>
	<a class="github-fork-ribbon" href="https://github.com/IrishMarineInstitute/ncgraphql.js" data-ribbon="Fork me on GitHub" title="Fork me on GitHub">Fork me on GitHub</a>
</body>

</html>
